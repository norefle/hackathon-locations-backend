<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<script src="https://code.jquery.com/jquery-1.11.3.min.js" type="text/javascript" charset="utf-8"></script>
<script src="http://js.api.here.com/se/2.5.4/jsl.js" type="text/javascript" charset="utf-8"></script>

<link rel="shortcut icon" href="img/favicon.ico" type="image/x-icon">

<style type="text/css">
    html {
        overflow:hidden;
    }

    body {
        margin: 0;
        padding: 0;
        position: absolute;
        overflow:hidden;
        width: 100%;
        height: 100%;
    }

    #mapContainer {
        width: 100%;
        height: 100%;
        left: 0;
        top: 0;
        position: absolute;
    }

    #controls {
        width: 50%;
        position: absolute;
        margin: 20px;
        padding: 5px;
        top: 0;
        left 0;
        display: block;
        background-color: #fafaff;
    }

    .position {
        font-size: small;
    }
</style>
</head>
<body>
    <div id="mapContainer"></div>
    <div id="controls">
        <span>Report hazard</span>
        <ul>
            <li>Reporter: <span id="watchName"></span>&nbsp;<span id="watchPosition" class="position"></span></li>
            <li>Severity: <span id="reportSev"></span></li>
            <li>Position: [<span id="reportLat"></span>;&nbsp;<span id="reportLon"></span>]</li>
        </ul>
    </div>
    <script type="text/javascript">
        nokia.Settings.set("app_id", "");
        nokia.Settings.set("app_code", "");
        var map = new nokia.maps.map.Display(document.getElementById("mapContainer"),
            {
                zoomLevel: 13,
                center: [52.526768, 13.393261], // Berlin
                components: [
                    new nokia.maps.map.component.Behavior(),
                    new nokia.maps.map.component.ZoomBar(),
                    new nokia.maps.map.component.ScaleBar()
                ]
            }
        );

        var mapObjects = [];

        var orange = new nokia.maps.util.Brush({ color: "#ffa500"});
        var red = new nokia.maps.util.Brush({ color: "#ff0000"});

        var vivoWatchId = "15700324b410fee6e51389d698f378b7357bc249";

        map.addListener("click", function(evt) {
            var position = map.pixelToGeo(evt.clientX, evt.clientY);
            $("#reportSev").text(0 === evt.button ? 1 : 2);
            $("#reportLat").text(position.latitude);
            $("#reportLon").text(position.longitude);
        });

        $("#controls").click(function() {
            var url = "/hazard/issue/report/"
                + vivoWatchId
                + "?cmd=post&lat=" + $("#reportLat").text()
                + "&lon=" + $("#reportLon").text()
                + "&severity=" + $("#reportSev").text()
                + "&heading=0.0&speed=0.0";
            $.getJSON(url).done(function(data) {
                console.log("report:", data);
            }).fail(function(error) {
                console.log("Report failed:", error);
            });
        });

        function iconByType(type) {
            // 0 - unknow, 1  - glass, 2 - construction, 3 - car on lane, 4 - bike crash
            switch (type) {
                case 1: return "glass.png";
                case 2: return "closure.png";
                case 3: return "parking.png";
            }

            return "unknown.png";
        }

        function cleanUp() {
            mapObjects.forEach(function(object) {
                map.objects.remove(object);
            });
            mapObjects = [];
        }

        function addMapObject(object) {
            map.objects.add(object);
            mapObjects.push(object);
        }

        function showHazards(clientId) {
            var issueUrl = "hazard/issue/new/" + clientId +"?cmd=get&since=0";

            $.getJSON(issueUrl).done(function(data) {
                $.each(data.issues, function(i, item) {
                    var issueIcon = new nokia.maps.map.Marker(
                        new nokia.maps.geo.Coordinate(item.latitude, item.longitude),
                        {
                            title: "marker",
                            visibility: true,
                            icon: "img/" + (item.severity === 1 ? "orange" : "red") + "/" + iconByType(item.type),
                            data: {
                                itemId: item.id
                            }
                        }
                    );
                    addMapObject(issueIcon);
                });
            }).fail(function(error) { console.log("Issue failure", error); });
        }

        function showPath(coordinates) {
            if (coordinates && Array.isArray(coordinates)) {
                var points = coordinates.map(function(point) { return { lat: point.latitude, lng: point.longitude }; });
                var path = new nokia.maps.map.Polyline(points);
                addMapObject(path);
            }
        }

        function showWatches(clientId) {
            var watchUrl = "hazard/watch/last/" + clientId;
            $.getJSON(watchUrl).done(function(data) {
                $("#watchName").text(data.description);
                $("#watchPosition").text("[" + data.latitude + "; " + data.longitude + "]");
                var area = new nokia.maps.map.Circle( {lat: data.latitude, lng: data.longitude}, 250);
                var watchIcon = new nokia.maps.map.Marker(
                    new nokia.maps.geo.Coordinate(data.latitude, data.longitude),
                    {
                        title: "Watch",
                        visibility: true,
                        icon: "img/watch.png",
                        anchor: new nokia.maps.util.Point(24, 24)
                    }
                );

                showPath(data.splits);

                addMapObject(area);
                addMapObject(watchIcon);
            }).fail(function(error) { console.log("Watch failure", error); });
        }

        function update() {
            cleanUp();
            showHazards(vivoWatchId);
            showWatches(vivoWatchId);
        }

        window.setInterval(update, 5000);
    </script>
</body>
</html>
